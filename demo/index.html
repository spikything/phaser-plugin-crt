<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>phaser-plugin-crt demo</title>
    <style>
      html, body { height: 100%; margin: 0; background:#111; color:#ddd; font-family: system-ui, sans-serif; }
      #game { width: 100%; height: 100%; }
      .controls {
        position: fixed;
        top: 12px;
        left: 12px;
        background: rgba(0,0,0,0.6);
        padding: 10px 12px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 220px;
      }
      .controls .buttons {
        display: flex;
        gap: 8px;
      }
      .sliders {
        position: fixed;
        top: 12px;
        right: 12px;
        background: rgba(0, 0, 0, 0.6);
        padding: 10px 12px;
        border-radius: 10px;
        display: grid;
        gap: 8px;
        width: 180px;
      }
      .slider-control {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .slider-control label {
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }
      .slider-control input[type="range"] {
        width: 100%;
      }
      a { color: #7dd3fc; }
    </style>
  </head>
  <body>
    <div class="controls">
      <div class="buttons">
        <button id="disable">Disable</button>
        <button id="randomise-all">Randomise</button>
      </div>
      <span><a href="https://github.com/spikything/phaser-plugin-crt">phaser-plugin-crt</a></span>
    </div>
    <div class="sliders" id="sliders"></div>
    <div id="game"></div>

    <!-- Phaser CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.js"></script>
    <!-- The plugin UMD build -->
    <script src="../dist-prebuilt/phaser-plugin-crt.umd.js"></script>
    <script>
      const { CRTPlugin } = PhaserPluginCRT;

      const PRESETS = {
        subtle: {
          curvature: 0.12,
          scanlineIntensity: 0.1,
          scanlineFreq: 1.8,
          wobbleAmp: 0.0004,
          wobbleFreq: 28,
          vignette: 0.35,
          desaturate: 0.05,
          gamma: 1.02,
          maskStrength: 0.03,
          noise: 0.03
        },
        arcade: {
          curvature: 0.2,
          scanlineIntensity: 0.2,
          scanlineFreq: 2.4,
          wobbleAmp: 0.0009,
          wobbleFreq: 44,
          vignette: 0.5,
          desaturate: 0.1,
          gamma: 1.06,
          maskStrength: 0.05,
          noise: 0.05
        },
        vhs: {
          curvature: 0.28,
          scanlineIntensity: 0.32,
          scanlineFreq: 3.2,
          wobbleAmp: 0.0016,
          wobbleFreq: 62,
          vignette: 0.6,
          desaturate: 0.18,
          gamma: 1.08,
          maskStrength: 0.06,
          noise: 0.08
        }
      };

      const RANDOM_RANGES = {
        curvature: [0.05, 0.35],
        scanlineIntensity: [0.05, 0.4],
        scanlineFreq: [1.5, 3.8],
        wobbleAmp: [0.0002, 0.0025],
        wobbleFreq: [20, 70],
        vignette: [0.25, 0.85],
        desaturate: [0.02, 0.35],
        gamma: [0.92, 1.12],
        maskStrength: [0.02, 0.08],
        noise: [0, 0.2]
      };

      const randomInRange = ([min, max]) => min + Math.random() * (max - min);

      class DemoScene extends Phaser.Scene {
        preload() {
          this.load.image('logo', 'https://labs.phaser.io/assets/sprites/phaser3-logo.png');
          this.load.image('bg', 'https://labs.phaser.io/assets/skies/deepblue.png');
        }
        create() {
          this.add
            .image(400, 300, 'bg')
            .setDisplaySize(this.scale.width, this.scale.height);
          const logo = this.add.image(400, 300, 'logo');
          this.tweens.add({ targets: logo, angle: 360, duration: 8000, repeat: -1 });

          // Map plugin
          this.plugins.installScenePlugin('CRTPlugin', CRTPlugin, 'crt', this);

          // Enable with some defaults
          const currentSettings = { ...PRESETS.arcade };
          this.crt.enable(currentSettings);

          let effectEnabled = true;

          const sliderSteps = {
            curvature: 0.01,
            scanlineIntensity: 0.01,
            scanlineFreq: 0.1,
            wobbleAmp: 0.0001,
            wobbleFreq: 1,
            vignette: 0.01,
            desaturate: 0.01,
            gamma: 0.01,
            maskStrength: 0.005,
            noise: 0.01
          };

          const sliderContainer = document.getElementById('sliders');
          const sliderRefs = {};

          const formatLabel = (key) =>
            key.replace(/([A-Z])/g, ' $1').replace(/^./, (ch) => ch.toUpperCase());

          const formatValue = (key, value) => {
            if (key === 'wobbleAmp') return value.toFixed(4);
            if (key === 'wobbleFreq') return value.toFixed(0);
            if (key === 'gamma') return value.toFixed(2);
            return value.toFixed(2);
          };

          Object.entries(RANDOM_RANGES).forEach(([key, [min, max]]) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'slider-control';

            const label = document.createElement('label');
            label.htmlFor = `slider-${key}`;
            const labelText = document.createElement('span');
            labelText.textContent = formatLabel(key);
            const valueDisplay = document.createElement('span');
            valueDisplay.id = `slider-value-${key}`;
            valueDisplay.textContent = formatValue(key, currentSettings[key]);
            label.appendChild(labelText);
            label.appendChild(valueDisplay);

            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = `slider-${key}`;
            slider.min = min;
            slider.max = max;
            slider.step = sliderSteps[key] ?? 0.01;
            slider.value = currentSettings[key];

            slider.addEventListener('input', () => {
              const value = parseFloat(slider.value);
              currentSettings[key] = value;
              valueDisplay.textContent = formatValue(key, value);

              if (!effectEnabled) {
                this.crt.enable(currentSettings);
                effectEnabled = true;
              } else {
                this.crt.update(currentSettings);
              }
            });

            wrapper.appendChild(label);
            wrapper.appendChild(slider);
            sliderContainer.appendChild(wrapper);
            sliderRefs[key] = { slider, valueDisplay };
          });

          document.getElementById('disable').onclick = () => {
            this.crt.disable();
            effectEnabled = false;
          };

          document.getElementById('randomise-all').onclick = () => {
            const randomised = Object.fromEntries(
              Object.entries(RANDOM_RANGES).map(([key, range]) => [key, randomInRange(range)])
            );

            Object.assign(currentSettings, randomised);

            Object.entries(randomised).forEach(([key, value]) => {
              const refs = sliderRefs[key];
              if (refs) {
                refs.slider.value = value;
                refs.valueDisplay.textContent = formatValue(key, value);
              }
            });

            if (!effectEnabled) {
              this.crt.enable(currentSettings);
              effectEnabled = true;
            } else {
              this.crt.update(randomised);
            }
          };
        }
      }

      const config = {
        type: Phaser.AUTO,
        parent: 'game',
        width: 800,
        height: 600,
        backgroundColor: '#000000',
        scene: [DemoScene]
      };

      new Phaser.Game(config);
    </script>
  </body>
</html>
